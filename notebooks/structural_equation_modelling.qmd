![](https://raw.githubusercontent.com/EcoCommons-Australia-2024-2026/ec-notebook_site/main/images/notebooks_banner_withframe.png)

# Structural Equation Modelling: Understanding hidden animal behaviour 

Author details: Dr Sebastian Lopez Marcano

Editor details: Xiang Zhao

Contact details: support\@ecocommons.org.au

Copyright statement: This script is the product of the EcoCommons platform. Please refer to the EcoCommons website for more details: <https://www.ecocommons.org.au/>

Date: February 2025

# Script and data info:

This notebook, developed by the EcoCommons team, showcases how to develop a structural equation model (SEM) to understand the 'hidden' relationships between different variables. The original material was developed by the FishID team from Griffith University, with support from Data61 CSIRO for Sebastian's PhD project. 

**Note**: This notebook is not an exhaustive guide to SEMs. We highly recommend you read the [SEM Book from Jon Lefcheck](https://jslefche.github.io/sem_book/). 

# Introduction
Structural equation modelling (SEM) allows us to determine relationships between variables and understand how each of them conribute to a particular outcome. SEMs are particularly useful when we have a large number of variables, data points and the relationships and outcomes are not particularly clear. 

To provide a simple example, SEMs can answer questions like "What factors influence how much I enjoy a pizza"?. We know that multiple factors can affect my or your pizza enjoyment (e.g., is the pizza hot, was the pizza homemade or from a Michelin star restaurant, etc.). 

## SEM Assumptions
Assumptions in statistical models are important and sometimes are overlooked because finding answer takes priority over following the process. SEMs have a few assumptions that need to be before we can build a model and interpret the results.

1. **Linearity**: The relationships between variables are linear. 
2. **Normality**: The data is normally distributed.
3. **Free of outliers**: The data does not contain outliers.
4. **Sample size**: Sample size ranging from 200 to 400 with 10 to 15 indicators per variable is generally recommended.
5. **No multicollinearity**: The data does not contain multicollinearity. Multicollinearity occurs when two or more independent variables are highly correlated with each other.

## Step by Step SEM Process
1. **Install and load required packages**: `lavaan` is the main package for SEMs in R
2. **Data preparation**: Load the data and check for missing values and check SEM assumptions.
3. **Explore correlations**: Explore relationships between variables and check for multicollinearity.
4. **Model specification**: Define the model; the model needs to make 'ecological sense' and built following some theoretical framework (e.g., fiddler crabs in coastal areas are more likely to be foraging during low tide). 

# Set-up: R Environment and Packages
Some housekeeping before we start. This process might take some time as many packages needed to be installed.

## S.1 Set the working directory and create a folder for data.
Save the Quarto Markdown file (.QMD) to a folder of your choice, and then set the path to your folder as your working directory.

```{r setup_workspace}

# Set the workspace to the current working directory

workspace <- getwd()  # Get the current working directory and store it in 'workspace'

# Increase the plot size by adjusting the options for plot dimensions in the notebook output
options(repr.plot.width = 16, repr.plot.height = 8)  # Sets width to 16 and height to 8 for larger plots
```

Ideally, you would use the **`renv`** package to create an isolated environment for installing all the required R packages used in this notebook. However, since installing **`renv`** and its dependencies can be time-consuming, we recommend trying this after the notebook.

```{r renv}

# # Ensure "renv" package is installed
# if (!requireNamespace("renv", quietly = TRUE)) {
#   install.packages("renv")
# }
# 
# # Check if renv has been initialized in the project
# if (!file.exists("renv/activate.R")) {
#   message("renv has not been initiated in this project. Initializing now...")
#   renv::init()  # Initialize renv if not already set up
# } else {
#   source("renv/activate.R")  # Activate the renv environment
#   message("renv is activated.")
# }
# 
# # Check for the existence of renv.lock and restore the environment
# if (file.exists("renv.lock")) {
#   message("Restoring renv environment from renv.lock...")
#   renv::restore()
# } else {
#   message("No renv.lock file found in the current directory. Skipping restore.")
# }

```

## S.2 Install and load essential libraries.

Install and load R packages. The following packages are required for this notebook:

```{r install_libraries, message=FALSE, warning=FALSE}

# Set CRAN mirror
options(repos = c(CRAN = "https://cran.rstudio.com/"))

# List of packages to check, install if needed, and load
packages <- c("tidyverse", "lavaan", "semPlot", "corrplot")

# Function to display a cat message
cat_message <- function(pkg, message_type) {
  if (message_type == "installed") {
    cat(paste0(pkg, " has been installed successfully!\n"))
  } else if (message_type == "loading") {
    cat(paste0(pkg, " is already installed and has been loaded!\n"))
  }
}

# Install missing packages and load them
for (pkg in packages) {
  if (!requireNamespace(pkg, quietly = TRUE)) {
    install.packages(pkg)
    cat_message(pkg, "installed")
  } else {
    cat_message(pkg, "loading")
  }
  library(pkg, character.only = TRUE)
}

# If you are using renv, you can snapshot the renv after loading all the packages.

#renv::snapshot()
```

# Data Access and Preparation
SEMs are particularly suitable for studying behavioural patterns in animals. In this example, we will use an adaptation of a dataset produced by the FishID project, Australia's largest solution for automated identification of fish species. 

The dataset contains tracking information of fish individuals swimming in a underwater pipe located in a natural estuary. The data was collected using an underwater camera and an AI algorithm with a fish tracker enabled. You do not need to use AI or cameras to collect data for SEMs; as long as you have continous data of individuals and their behaviours, you can use SEMs to understand the relationships between variables.

## 1 Load the data
The dataset is stored in a CSV file. We will load the data and check the first few rows to understand the structure of the data.
```
